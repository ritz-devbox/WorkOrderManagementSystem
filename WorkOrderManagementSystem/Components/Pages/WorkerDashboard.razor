@page "/worker/dashboard"
@using WorkOrderManagementSystem.Data
@using WorkOrderManagementSystem.Services
@using Microsoft.EntityFrameworkCore
@inject WorkOrderContext Db
@inject SessionService Session
@inject NavigationManager Nav
@layout WorkOrderManagementSystem.Components.Layout.WorkerLayout
@rendermode InteractiveServer

<PageTitle>Worker Dashboard</PageTitle>

@if (!Session.IsAuthenticated || Session.CurrentRole != Role.Worker)
{
    <div class="container mt-5">
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle me-2"></i>
            Please <a href="/worker/login">login</a> to access the worker dashboard.
        </div>
    </div>
    Nav.NavigateTo("/worker/login");
    return;
}

<div class="container-fluid mt-4 animate-fade-in">
    <!-- Header -->
    <div class="row mb-4 align-items-center">
        <div class="col-md-6">
            <h1 class="display-5 fw-bold mb-2">
                <i class="bi bi-wrench me-3 text-primary"></i>Worker Dashboard
            </h1>
            <p class="lead text-muted">Welcome back, <strong>@Session.CurrentUser?.FullName</strong></p>
        </div>
        <div class="col-md-6 text-md-end">
            <div class="btn-group me-3 shadow-sm" role="group">
                <button type="button" class="btn @(isBoardView ? "btn-outline-primary" : "btn-primary")" @onclick="() => isBoardView = false">
                    <i class="bi bi-list-ul me-2"></i>List
                </button>
                <button type="button" class="btn @(isBoardView ? "btn-primary" : "btn-outline-primary")" @onclick="() => isBoardView = true">
                    <i class="bi bi-kanban me-2"></i>Board
                </button>
            </div>
            <button class="btn btn-outline-danger rounded-pill" @onclick="Logout">
                <i class="bi bi-box-arrow-right me-2"></i>Logout
            </button>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row g-4 mb-5">
        <div class="col-md-4">
            <div class="card border-0 shadow-glass h-100 animate-float" style="animation-delay: 0s;">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div class="p-3 rounded-circle bg-warning bg-opacity-10">
                            <i class="bi bi-clipboard-check fs-3 text-warning"></i>
                        </div>
                        <span class="badge bg-warning bg-opacity-10 text-warning">Assigned</span>
                    </div>
                    <h2 class="display-4 fw-bold mb-1">@assignedCount</h2>
                    <p class="text-muted mb-0">My Assigned Orders</p>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card border-0 shadow-glass h-100 animate-float" style="animation-delay: 0.1s;">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div class="p-3 rounded-circle bg-primary bg-opacity-10">
                            <i class="bi bi-hourglass-split fs-3 text-primary"></i>
                        </div>
                        <span class="badge bg-primary bg-opacity-10 text-primary">Active</span>
                    </div>
                    <h2 class="display-4 fw-bold mb-1">@inProgressCount</h2>
                    <p class="text-muted mb-0">In Progress</p>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card border-0 shadow-glass h-100 animate-float" style="animation-delay: 0.2s;">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div class="p-3 rounded-circle bg-success bg-opacity-10">
                            <i class="bi bi-check-circle-fill fs-3 text-success"></i>
                        </div>
                        <span class="badge bg-success bg-opacity-10 text-success">Done</span>
                    </div>
                    <h2 class="display-4 fw-bold mb-1">@completedCount</h2>
                    <p class="text-muted mb-0">Total Completed</p>
                </div>
            </div>
        </div>
    </div>

    @if (isBoardView)
    {
        <!-- Kanban Board View -->
        <div class="row g-4">
            <!-- To Do Column -->
            <div class="col-md-4">
                <div class="card border-0 shadow-glass h-100 bg-light bg-opacity-50">
                    <div class="card-header bg-transparent border-0 pt-3 px-3">
                        <h5 class="fw-bold mb-0 text-secondary"><i class="bi bi-circle me-2"></i>To Do</h5>
                    </div>
                    <div class="card-body p-3">
                        @foreach (var order in assignedOrders.Where(o => o.Status == WorkOrderStatus.New))
                        {
                            <div class="card border-0 shadow-sm mb-3 hover-lift">
                                <div class="card-body p-3">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span class="badge @GetPriorityBadgeClass(order.Priority)">@order.Priority</span>
                                        <small class="text-muted">@order.Timestamp.ToLocalTime().ToString("MMM dd")</small>
                                    </div>
                                    <h6 class="fw-bold">
                                        <a href="/worker/order/@order.Id" class="text-decoration-none text-dark hover-primary">
                                            @order.Description
                                        </a>
                                    </h6>
                                    <p class="small text-muted mb-2"><i class="bi bi-geo-alt me-1"></i>@order.Location</p>
                                    <button class="btn btn-sm btn-primary w-100" @onclick="() => StartWork(order.Id)">
                                        Start Work <i class="bi bi-arrow-right ms-1"></i>
                                    </button>
                                </div>
                            </div>
                        }
                        @if (!assignedOrders.Any(o => o.Status == WorkOrderStatus.New))
                        {
                            <div class="text-center text-muted py-4 opacity-50">No new tasks</div>
                        }
                    </div>
                </div>
            </div>

            <!-- In Progress Column -->
            <div class="col-md-4">
                <div class="card border-0 shadow-glass h-100 bg-primary bg-opacity-10">
                    <div class="card-header bg-transparent border-0 pt-3 px-3">
                        <h5 class="fw-bold mb-0 text-primary"><i class="bi bi-play-circle me-2"></i>In Progress</h5>
                    </div>
                    <div class="card-body p-3">
                        @foreach (var order in assignedOrders.Where(o => o.Status == WorkOrderStatus.InProgress))
                        {
                            <div class="card border-0 shadow-sm mb-3 hover-lift border-start border-4 border-primary">
                                <div class="card-body p-3">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span class="badge @GetPriorityBadgeClass(order.Priority)">@order.Priority</span>
                                        <span class="badge bg-primary bg-opacity-10 text-primary">Active</span>
                                    </div>
                                    <h6 class="fw-bold">
                                        <a href="/worker/order/@order.Id" class="text-decoration-none text-dark hover-primary">
                                            @order.Description
                                        </a>
                                    </h6>
                                    <p class="small text-muted mb-2"><i class="bi bi-geo-alt me-1"></i>@order.Location</p>
                                    <button class="btn btn-sm btn-success w-100" @onclick="() => CompleteWork(order.Id)">
                                        <i class="bi bi-check-lg me-1"></i>Mark Complete
                                    </button>
                                </div>
                            </div>
                        }
                         @if (!assignedOrders.Any(o => o.Status == WorkOrderStatus.InProgress))
                        {
                            <div class="text-center text-muted py-4 opacity-50">Nothing in progress</div>
                        }
                    </div>
                </div>
            </div>

            <!-- Done Column -->
            <div class="col-md-4">
                <div class="card border-0 shadow-glass h-100 bg-success bg-opacity-10">
                    <div class="card-header bg-transparent border-0 pt-3 px-3">
                        <h5 class="fw-bold mb-0 text-success"><i class="bi bi-check-circle me-2"></i>Completed</h5>
                    </div>
                    <div class="card-body p-3">
                        @foreach (var order in assignedOrders.Where(o => o.Status == WorkOrderStatus.Completed).OrderByDescending(o => o.Timestamp).Take(5))
                        {
                            <div class="card border-0 shadow-sm mb-3 opacity-75">
                                <div class="card-body p-3">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span class="badge bg-success">Done</span>
                                        <small class="text-muted">@order.Timestamp.ToLocalTime().ToString("MMM dd")</small>
                                    </div>
                                    <h6 class="fw-bold text-decoration-line-through text-muted">
                                        <a href="/worker/order/@order.Id" class="text-decoration-none text-muted hover-primary">
                                            @order.Description
                                        </a>
                                    </h6>
                                    <p class="small text-muted mb-0"><i class="bi bi-geo-alt me-1"></i>@order.Location</p>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <!-- List View (Original) -->
        <div class="card border-0 shadow-glass">
            <div class="card-header bg-transparent border-0 pt-4 px-4">
                <h4 class="mb-0 fw-bold">
                    <i class="bi bi-list-task me-2 text-primary"></i>My Assigned Work Orders
                </h4>
            </div>
            <div class="card-body p-0">
                @if (assignedOrders.Any())
                {
                    <div class="list-group list-group-flush">
                        @foreach (var order in assignedOrders)
                        {
                            <div class="list-group-item p-4 border-top hover-lift transition-all">
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <div class="d-flex gap-2 mb-2">
                                            <span class="badge @GetPriorityBadgeClass(order.Priority)">@order.Priority</span>
                                            <span class="badge @GetStatusBadgeClass(order.Status)">@order.Status</span>
                                            <span class="badge bg-light text-dark">@order.Category?.Name</span>
                                        </div>
                                        <h5 class="fw-bold mb-2">
                                        <a href="/worker/order/@order.Id" class="text-decoration-none text-dark hover-primary">
                                            @order.Description
                                        </a>
                                    </h5>
                                        <p class="text-muted small mb-0">
                                            <i class="bi bi-geo-alt me-1"></i>@order.Location
                                            <span class="mx-2">â€¢</span>
                                            <i class="bi bi-clock me-1"></i>@order.Timestamp.ToLocalTime().ToString("g")
                                        </p>
                                    </div>
                                    <div class="col-md-4 text-md-end mt-3 mt-md-0">
                                        @if (order.Status != WorkOrderStatus.Completed)
                                        {
                                            <div class="btn-group">
                                                @if (order.Status == WorkOrderStatus.New)
                                                {
                                                    <button class="btn btn-primary btn-sm" @onclick="() => StartWork(order.Id)">
                                                        <i class="bi bi-play-fill me-1"></i>Start Work
                                                    </button>
                                                }
                                                @if (order.Status == WorkOrderStatus.InProgress)
                                                {
                                                    <button class="btn btn-success btn-sm" @onclick="() => CompleteWork(order.Id)">
                                                        <i class="bi bi-check-circle me-1"></i>Mark Complete
                                                    </button>
                                                }
                                            </div>
                                        }
                                        else
                                        {
                                            <span class="badge bg-success p-2">
                                                <i class="bi bi-check-circle-fill me-1"></i>Completed
                                            </span>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="text-center py-5">
                        <i class="bi bi-inbox fs-1 text-muted opacity-50"></i>
                        <p class="text-muted mt-3">No work orders assigned yet.</p>
                    </div>
                }
            </div>
        </div>
    }
</div>

@code {
    private List<WorkOrder> assignedOrders = new();
    private int assignedCount;
    private int inProgressCount;
    private int completedCount;
    private bool isBoardView = true; // Default to Board View for "awesomeness"

    protected override async Task OnInitializedAsync()
    {
        Console.WriteLine($"WorkerDashboard: OnInitializedAsync started. (Service ID: {Session.InstanceId})");
        try 
        {
            if (Session.IsAuthenticated && Session.CurrentRole == Role.Worker)
            {
                Console.WriteLine($"WorkerDashboard: User authenticated as {Session.CurrentUser?.Username}. Loading data...");
                await LoadData();
                Console.WriteLine("WorkerDashboard: Data loaded successfully.");
            }
            else
            {
                Console.WriteLine("WorkerDashboard: User NOT authenticated or wrong role.");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"WorkerDashboard: Error in OnInitializedAsync: {ex}");
        }
    }

    private async Task LoadData()
    {
        var workerUsername = Session.CurrentUser?.Username ?? "";

        assignedOrders = await Db.WorkOrders
            .Include(w => w.Category)
            .Where(w => w.AssignedTo == workerUsername)
            .OrderBy(w => w.Status)
            .ThenByDescending(w => w.Priority)
            .ToListAsync();

        assignedCount = assignedOrders.Count;
        inProgressCount = assignedOrders.Count(w => w.Status == WorkOrderStatus.InProgress);
        
        completedCount = assignedOrders.Count(w => w.Status == WorkOrderStatus.Completed);
    }

    private async Task StartWork(int orderId)
    {
        var order = await Db.WorkOrders.FindAsync(orderId);
        if (order != null)
        {
            order.Status = WorkOrderStatus.InProgress;
            await Db.SaveChangesAsync();
            await LoadData();
        }
    }

    private async Task CompleteWork(int orderId)
    {
        var order = await Db.WorkOrders.FindAsync(orderId);
        if (order != null)
        {
            order.Status = WorkOrderStatus.Completed;
            await Db.SaveChangesAsync();
            await LoadData();
        }
    }

    private void Logout()
    {
        Session.Logout();
        Nav.NavigateTo("/worker/login");
    }

    private string GetPriorityBadgeClass(WorkOrderPriority p) => p switch
    {
        WorkOrderPriority.Low => "bg-info",
        WorkOrderPriority.Medium => "bg-primary",
        WorkOrderPriority.High => "bg-warning text-dark",
        WorkOrderPriority.Critical => "bg-danger",
        _ => "bg-secondary"
    };

    private string GetStatusBadgeClass(WorkOrderStatus s) => s switch
    {
        WorkOrderStatus.New => "bg-secondary",
        WorkOrderStatus.InProgress => "bg-primary",
        WorkOrderStatus.Completed => "bg-success",
        _ => "bg-light text-dark"
    };
}
