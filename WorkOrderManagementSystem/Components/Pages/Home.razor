@page "/"
@using WorkOrderManagementSystem.Data
@using WorkOrderManagementSystem.Services
@using Microsoft.EntityFrameworkCore
@inject WorkOrderContext Db
@inject NavigationManager Nav
@inject SmartTriageService SmartTriage
@inject NotificationService Notifications
@layout WorkOrderManagementSystem.Components.Layout.PublicLayout
@rendermode InteractiveServer

<PageTitle>Work Order System</PageTitle>

<div class="min-vh-100" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);">
    <!-- Hero Section -->
    <div class="container py-5">
        <div class="row justify-content-center text-center text-white mb-5 animate-fade-in">
            <div class="col-lg-8">
                <div class="mb-4">
                    <i class="bi bi-tools" style="font-size: 4rem;"></i>
                </div>
                <h1 class="display-3 fw-bold mb-3" style="color: white !important; background: none; -webkit-text-fill-color: white;">
                    Work Order System
                </h1>
                <p class="lead mb-4" style="color: rgba(255,255,255,0.9);">
                    Submit maintenance requests instantly. Track your order status in real-time.
                </p>
            </div>
        </div>

        <div class="row g-4">
            <!-- Create Work Order Card -->
            <div class="col-lg-6">
                <div class="card border-0 shadow-glass h-100" style="backdrop-filter: blur(20px); background: rgba(255, 255, 255, 0.95);">
                    <div class="card-body p-5">
                        <div class="d-flex align-items-center mb-4">
                            <div class="p-3 rounded-circle bg-primary bg-opacity-10 me-3">
                                <i class="bi bi-plus-circle-fill text-primary fs-3"></i>
                            </div>
                            <div>
                                <h3 class="mb-0 fw-bold">Create Work Order</h3>
                                <p class="text-muted small mb-0">No account required</p>
                            </div>
                        </div>

                        @if (!string.IsNullOrEmpty(successMessage))
                        {
                            <div class="alert alert-success border-0 shadow-sm animate-fade-in">
                                <i class="bi bi-check-circle me-2"></i>
                                <strong>Success!</strong> Your work order has been created.
                                <div class="mt-2 p-3 bg-white rounded">
                                    <p class="mb-1 small text-muted">Track your order with ID:</p>
                                    <h4 class="mb-0 font-monospace text-primary">@trackingId</h4>
                                </div>
                            </div>
                        }

                        @if (!string.IsNullOrEmpty(errorMessage))
                        {
                            <div class="alert alert-danger border-0 shadow-sm">
                                <i class="bi bi-exclamation-triangle me-2"></i>@errorMessage
                            </div>
                        }

                        <EditForm Model="workOrder" OnValidSubmit="CreateWorkOrder" FormName="publicWorkOrderForm">
                            <DataAnnotationsValidator />

                            <div class="mb-3">
                                <label class="form-label fw-semibold">Your Name</label>
                                <InputText @bind-Value="workOrder.Username" 
                                           class="form-control shadow-none" 
                                           placeholder="Enter your name" />
                                <ValidationMessage For="() => workOrder.Username" class="text-danger small" />
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-semibold">Category</label>
                                <InputSelect @bind-Value="workOrder.CategoryId" class="form-select shadow-none">
                                    <option value="0">Select category...</option>
                                    @foreach (var cat in categories)
                                    {
                                        <option value="@cat.Id">@cat.Name</option>
                                    }
                                </InputSelect>
                                <ValidationMessage For="() => workOrder.CategoryId" class="text-danger small" />
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-semibold">Description</label>
                                <InputTextArea @bind-Value="workOrder.Description" 
                                               @oninput="OnDescriptionChanged"
                                               class="form-control shadow-none" 
                                               rows="3"
                                               placeholder="Describe the issue..." />
                                <ValidationMessage For="() => workOrder.Description" class="text-danger small" />
                                
                                @if (!string.IsNullOrEmpty(aiSuggestion))
                                {
                                    <div class="alert alert-info border-0 mt-2 animate-fade-in">
                                        <i class="bi bi-robot me-2"></i>
                                        <strong>AI Suggestion:</strong> @aiSuggestion
                                    </div>
                                }
                            </div>

                            <div class="mb-4">
                                <label class="form-label fw-semibold">Location</label>
                                <InputText @bind-Value="workOrder.Location" 
                                           class="form-control shadow-none" 
                                           placeholder="Building, floor, room number" />
                                <ValidationMessage For="() => workOrder.Location" class="text-danger small" />
                            </div>

                            <button type="submit" class="btn btn-primary w-100 py-3 fw-semibold shadow-glow" disabled="@isSubmitting">
                                @if (isSubmitting)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                    <span>Submitting...</span>
                                }
                                else
                                {
                                    <i class="bi bi-send-fill me-2"></i>
                                    <span>Submit Work Order</span>
                                }
                            </button>
                        </EditForm>
                    </div>
                </div>
            </div>

            <!-- Track Order & Portal Links -->
            <div class="col-lg-6">
                <!-- Track Order Card -->
                <div class="card border-0 shadow-glass mb-4" style="backdrop-filter: blur(20px); background: rgba(255, 255, 255, 0.95);">
                    <div class="card-body p-5">
                        <div class="d-flex align-items-center mb-4">
                            <div class="p-3 rounded-circle bg-info bg-opacity-10 me-3">
                                <i class="bi bi-search text-info fs-3"></i>
                            </div>
                            <div>
                                <h3 class="mb-0 fw-bold">Track Your Order</h3>
                                <p class="text-muted small mb-0">Check status anytime</p>
                            </div>
                        </div>

                        <div class="input-group mb-3">
                            <input type="text" 
                                   class="form-control shadow-none" 
                                   placeholder="Enter tracking ID (e.g., WO-001)"
                                   @bind="trackingSearch" />
                            <button class="btn btn-info" @onclick="TrackOrder">
                                <i class="bi bi-search"></i> Track
                            </button>
                        </div>

                        @if (trackedOrder != null)
                        {
                            <div class="p-3 bg-light rounded">
                                <h6 class="fw-bold mb-2">@trackedOrder.Description</h6>
                                <div class="d-flex gap-2 mb-2">
                                    <span class="badge @GetStatusBadgeClass(trackedOrder.Status)">@trackedOrder.Status</span>
                                    <span class="badge bg-secondary">@trackedOrder.Category?.Name</span>
                                </div>
                                <p class="small text-muted mb-0">
                                    <i class="bi bi-geo-alt me-1"></i>@trackedOrder.Location
                                </p>
                            </div>
                        }
                    </div>
                </div>

                <!-- Portal Links -->
                <div class="card border-0 shadow-glass" style="backdrop-filter: blur(20px); background: rgba(255, 255, 255, 0.95);">
                    <div class="card-body p-4">
                        <h5 class="fw-bold mb-3">Staff Portals</h5>
                        
                        <a href="/worker/login" class="btn btn-outline-primary w-100 mb-3 py-3 text-start">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-wrench fs-4 me-3"></i>
                                <div>
                                    <div class="fw-semibold">Worker Portal</div>
                                    <small class="text-muted">Manage assigned orders</small>
                                </div>
                                <i class="bi bi-arrow-right ms-auto"></i>
                            </div>
                        </a>

                        <a href="/admin/login" class="btn btn-outline-danger w-100 py-3 text-start">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-shield-fill-check fs-4 me-3"></i>
                                <div>
                                    <div class="fw-semibold">Admin Portal</div>
                                    <small class="text-muted">System management</small>
                                </div>
                                <i class="bi bi-arrow-right ms-auto"></i>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private WorkOrder workOrder = new();
    private List<Category> categories = new();
    private string successMessage = "";
    private string errorMessage = "";
    private string trackingId = "";
    private bool isSubmitting = false;
    private string trackingSearch = "";
    private WorkOrder? trackedOrder;
    private string aiSuggestion = "";

    protected override async Task OnInitializedAsync()
    {
        categories = await Db.Categories.ToListAsync();
        ResetForm();
    }
    
    private void OnDescriptionChanged(ChangeEventArgs e)
    {
        var description = e.Value?.ToString() ?? "";
        workOrder.Description = description;
        
        if (description.Length > 10)
        {
            // AI Priority Prediction
            var predictedPriority = SmartTriage.PredictPriority(description);
            var priorityText = predictedPriority switch
            {
                WorkOrderPriority.Critical => "🔴 CRITICAL priority detected",
                WorkOrderPriority.High => "🟡 HIGH priority suggested",
                WorkOrderPriority.Low => "🟢 LOW priority suggested",
                _ => "⚪ MEDIUM priority"
            };
            
            // AI Category Prediction
            var predictedCategoryId = SmartTriage.PredictCategory(description, categories);
            var categoryText = "";
            if (predictedCategoryId.HasValue)
            {
                var cat = categories.FirstOrDefault(c => c.Id == predictedCategoryId.Value);
                if (cat != null)
                {
                    categoryText = $" | Category: {cat.Name}";
                    workOrder.CategoryId = cat.Id; // Auto-select
                }
            }
            
            aiSuggestion = $"{priorityText}{categoryText}";
            workOrder.Priority = predictedPriority;
        }
        else
        {
            aiSuggestion = "";
        }
    }

    private async Task CreateWorkOrder()
    {
        isSubmitting = true;
        errorMessage = "";
        successMessage = "";

        try
        {
            workOrder.Timestamp = DateTime.UtcNow;
            workOrder.Status = WorkOrderStatus.New;
            
            // Use AI-predicted priority if not manually set
            if (workOrder.Priority == WorkOrderPriority.Medium && !string.IsNullOrEmpty(workOrder.Description))
            {
                workOrder.Priority = SmartTriage.PredictPriority(workOrder.Description);
            }
            
            // Calculate SLA deadline
            workOrder.SLADeadline = SmartTriage.CalculateSLADeadline(workOrder.Priority, workOrder.Timestamp);

            Db.WorkOrders.Add(workOrder);
            await Db.SaveChangesAsync();

            trackingId = $"WO-{workOrder.Id:D3}";
            successMessage = "Work order created successfully!";
            
            // Send notification
            Notifications.NotifyNewWorkOrder(workOrder);

            ResetForm();
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to create work order: {ex.Message}";
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private async Task TrackOrder()
    {
        trackedOrder = null;
        
        if (string.IsNullOrWhiteSpace(trackingSearch)) return;

        // Extract ID from format "WO-001"
        var idStr = trackingSearch.Replace("WO-", "").Replace("wo-", "").Trim();
        if (int.TryParse(idStr, out int id))
        {
            trackedOrder = await Db.WorkOrders
                .Include(w => w.Category)
                .FirstOrDefaultAsync(w => w.Id == id);
        }
    }

    private void ResetForm()
    {
        workOrder = new WorkOrder
        {
            Username = "",
            CategoryId = 1,
            Description = "",
            Location = ""
        };
    }

    private string GetStatusBadgeClass(WorkOrderStatus status) => status switch
    {
        WorkOrderStatus.New => "bg-secondary",
        WorkOrderStatus.InProgress => "bg-primary",
        WorkOrderStatus.Completed => "bg-success",
        _ => "bg-light text-dark"
    };
}
