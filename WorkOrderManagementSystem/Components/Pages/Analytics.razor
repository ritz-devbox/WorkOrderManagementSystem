@page "/admin/analytics"
@using WorkOrderManagementSystem.Data
@using WorkOrderManagementSystem.Services
@using Microsoft.EntityFrameworkCore
@inject WorkOrderContext Db
@inject NavigationManager Nav
@inject SessionService Session
@layout WorkOrderManagementSystem.Components.Layout.AdminLayout
@rendermode InteractiveServer

<PageTitle>Analytics Dashboard</PageTitle>

@if (!Session.IsAuthenticated || Session.CurrentRole != Role.Admin)
{
    Nav.NavigateTo("/admin/login", true);
    return;
}

}

<div class="container-fluid mt-4 animate-fade-in">
    <div class="row mb-5 align-items-center">
        <div class="col-md-8">
            <h1 class="display-4 fw-bold mb-2">
                <span class="bi bi-graph-up me-3 text-primary"></span>Analytics Dashboard
            </h1>
            <p class="lead text-muted">
                Insights and trends for data-driven decision making
            </p>
        </div>
        <div class="col-md-4 text-md-end">
            <button class="btn btn-outline-primary rounded-pill" @onclick="RefreshData">
                <i class="bi bi-arrow-clockwise me-2"></i>Refresh Data
            </button>
        </div>
    </div>

    <!-- KPI Cards -->
    <div class="row g-4 mb-5">
        <div class="col-md-3">
            <div class="card border-0 shadow-glass h-100 animate-float" style="animation-delay: 0s;">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center justify-content-between mb-3">
                        <div class="p-3 rounded-circle bg-success bg-opacity-10">
                            <i class="bi bi-check-circle-fill fs-3 text-success"></i>
                        </div>
                        <span class="badge bg-success bg-opacity-10 text-success">+@completionRate.ToString("F1")%</span>
                    </div>
                    <h3 class="display-5 fw-bold mb-1">@completedCount</h3>
                    <p class="text-muted mb-0 small fw-medium">Completed This Month</p>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card border-0 shadow-glass h-100 animate-float" style="animation-delay: 0.1s;">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center justify-content-between mb-3">
                        <div class="p-3 rounded-circle bg-warning bg-opacity-10">
                            <i class="bi bi-clock-history fs-3 text-warning"></i>
                        </div>
                        <span class="badge bg-warning bg-opacity-10 text-warning">Avg</span>
                    </div>
                    <h3 class="display-5 fw-bold mb-1">@avgResolutionTime.ToString("F1")h</h3>
                    <p class="text-muted mb-0 small fw-medium">Avg Resolution Time</p>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card border-0 shadow-glass h-100 animate-float" style="animation-delay: 0.2s;">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center justify-content-between mb-3">
                        <div class="p-3 rounded-circle bg-danger bg-opacity-10">
                            <i class="bi bi-exclamation-triangle-fill fs-3 text-danger"></i>
                        </div>
                        <span class="badge bg-danger bg-opacity-10 text-danger">Critical</span>
                    </div>
                    <h3 class="display-5 fw-bold mb-1">@overdueCount</h3>
                    <p class="text-muted mb-0 small fw-medium">Overdue Orders</p>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card border-0 shadow-glass h-100 animate-float" style="animation-delay: 0.3s;">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center justify-content-between mb-3">
                        <div class="p-3 rounded-circle bg-info bg-opacity-10">
                            <i class="bi bi-people-fill fs-3 text-info"></i>
                        </div>
                        <span class="badge bg-info bg-opacity-10 text-info">Active</span>
                    </div>
                    <h3 class="display-5 fw-bold mb-1">@activeUsers</h3>
                    <p class="text-muted mb-0 small fw-medium">Active Contributors</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row g-4 mb-5">
        <!-- Trend Chart -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-glass h-100">
                <div class="card-header bg-transparent border-0 pt-4 px-4">
                    <h5 class="mb-0 fw-bold"><i class="bi bi-graph-up-arrow me-2 text-primary"></i>Work Order Trends (Last 7 Days)</h5>
                </div>
                <div class="card-body p-4">
                    <div class="chart-container" style="position: relative; height: 300px;">
                        <!-- CSS Bar Chart -->
                        <div class="d-flex align-items-end justify-content-around h-100 gap-2">
                            @foreach (var day in trendData)
                            {
                                <div class="d-flex flex-column align-items-center flex-fill">
                                    <div class="position-relative w-100 d-flex flex-column justify-content-end" style="height: 250px;">
                                        <div class="rounded-top shadow-sm position-relative" 
                                             style="height: @(day.Count * 10)px; 
                                                    background: linear-gradient(180deg, var(--primary) 0%, var(--info) 100%);
                                                    min-height: 20px;
                                                    transition: all 0.3s ease;">
                                            <span class="position-absolute top-0 start-50 translate-middle-x badge bg-white text-dark shadow-sm" style="margin-top: -15px;">
                                                @day.Count
                                            </span>
                                        </div>
                                    </div>
                                    <small class="text-muted fw-medium mt-2">@day.Date.ToString("ddd")</small>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Category Breakdown -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-glass h-100">
                <div class="card-header bg-transparent border-0 pt-4 px-4">
                    <h5 class="mb-0 fw-bold"><i class="bi bi-tags-fill me-2 text-primary"></i>By Category</h5>
                </div>
                <div class="card-body p-4">
                    @foreach (var cat in categoryBreakdown)
                    {
                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="fw-medium">@cat.Name</span>
                                <span class="badge bg-primary bg-opacity-10 text-primary">@cat.Count</span>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-gradient" 
                                     style="width: @(cat.Percentage)%; background: linear-gradient(90deg, var(--primary), var(--info));"
                                     role="progressbar"></div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Metrics -->
    <div class="row g-4">
        <div class="col-lg-6">
            <div class="card border-0 shadow-glass h-100">
                <div class="card-header bg-transparent border-0 pt-4 px-4">
                    <h5 class="mb-0 fw-bold"><i class="bi bi-speedometer2 me-2 text-warning"></i>Performance Metrics</h5>
                </div>
                <div class="card-body p-4">
                    <div class="row g-3">
                        <div class="col-6">
                            <div class="text-center p-3 rounded-3 bg-light">
                                <h4 class="fw-bold text-primary mb-1">@firstResponseTime.ToString("F1")h</h4>
                                <small class="text-muted">First Response Time</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center p-3 rounded-3 bg-light">
                                <h4 class="fw-bold text-success mb-1">@customerSatisfaction.ToString("F1")%</h4>
                                <small class="text-muted">Satisfaction Rate</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center p-3 rounded-3 bg-light">
                                <h4 class="fw-bold text-info mb-1">@reopenRate.ToString("F1")%</h4>
                                <small class="text-muted">Reopen Rate</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center p-3 rounded-3 bg-light">
                                <h4 class="fw-bold text-warning mb-1">@slaCompliance.ToString("F1")%</h4>
                                <small class="text-muted">SLA Compliance</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card border-0 shadow-glass h-100">
                <div class="card-header bg-transparent border-0 pt-4 px-4">
                    <h5 class="mb-0 fw-bold"><i class="bi bi-trophy-fill me-2 text-warning"></i>Top Contributors</h5>
                </div>
                <div class="card-body p-4">
                    @foreach (var contributor in topContributors)
                    {
                        <div class="d-flex align-items-center mb-3 p-2 rounded-3 hover-lift" style="transition: all 0.2s;">
                            <div class="flex-shrink-0 me-3">
                                <div class="rounded-circle bg-primary bg-opacity-10 d-flex align-items-center justify-content-center" 
                                     style="width: 45px; height: 45px;">
                                    <span class="fw-bold text-primary">@contributor.Username.Substring(0, 1)</span>
                                </div>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="mb-0 fw-bold">@contributor.Username</h6>
                                <small class="text-muted">@contributor.Count orders completed</small>
                            </div>
                            <div class="badge bg-success bg-opacity-10 text-success rounded-pill px-3">
                                <i class="bi bi-star-fill me-1"></i>@contributor.Count
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {

    
    // KPIs
    private int completedCount;
    private double completionRate;
    private double avgResolutionTime;
    private int overdueCount;
    private int activeUsers;

    // Charts
    private List<TrendData> trendData = new();
    private List<CategoryData> categoryBreakdown = new();

    // Performance
    private double firstResponseTime;
    private double customerSatisfaction = 94.5;
    private double reopenRate = 3.2;
    private double slaCompliance = 96.8;

    // Contributors
    private List<ContributorData> topContributors = new();

    protected override async Task OnInitializedAsync()
    {
        if (Session.IsAuthenticated && Session.CurrentRole == Role.Admin)
        {
            await LoadAnalyticsData();
        }
    }

    private async Task LoadAnalyticsData()
    {
        var now = DateTime.UtcNow;
        var monthStart = new DateTime(now.Year, now.Month, 1);

        // KPIs
        completedCount = await Db.WorkOrders
            .CountAsync(w => w.Status == WorkOrderStatus.Completed && w.Timestamp >= monthStart);

        var totalThisMonth = await Db.WorkOrders.CountAsync(w => w.Timestamp >= monthStart);
        completionRate = totalThisMonth > 0 ? (completedCount * 100.0 / totalThisMonth) : 0;

        // Simulated metrics (in real app, calculate from actual data)
        avgResolutionTime = 4.2;
        overdueCount = await Db.WorkOrders.CountAsync(w => w.Status != WorkOrderStatus.Completed && w.Priority == WorkOrderPriority.Critical);
        activeUsers = await Db.WorkOrders.Select(w => w.Username).Distinct().CountAsync();
        firstResponseTime = 1.8;

        // Trend Data (Last 7 days)
        trendData = Enumerable.Range(0, 7)
            .Select(i => {
                var date = now.AddDays(-6 + i).Date;
                var count = Db.WorkOrders.Count(w => w.Timestamp.Date == date);
                return new TrendData { Date = date, Count = count };
            })
            .ToList();

        // Category Breakdown
        var categories = await Db.Categories.ToListAsync();
        var totalOrders = await Db.WorkOrders.CountAsync();
        
        categoryBreakdown = categories.Select(c => {
            var count = Db.WorkOrders.Count(w => w.CategoryId == c.Id);
            return new CategoryData 
            { 
                Name = c.Name, 
                Count = count,
                Percentage = totalOrders > 0 ? (count * 100.0 / totalOrders) : 0
            };
        }).OrderByDescending(c => c.Count).ToList();

        // Top Contributors
        topContributors = await Db.WorkOrders
            .Where(w => w.Status == WorkOrderStatus.Completed)
            .GroupBy(w => w.Username)
            .Select(g => new ContributorData { Username = g.Key, Count = g.Count() })
            .OrderByDescending(c => c.Count)
            .Take(5)
            .ToListAsync();
    }

    private async Task RefreshData()
    {
        await LoadAnalyticsData();
        StateHasChanged();
    }

    private class TrendData
    {
        public DateTime Date { get; set; }
        public int Count { get; set; }
    }

    private class CategoryData
    {
        public string Name { get; set; } = string.Empty;
        public int Count { get; set; }
        public double Percentage { get; set; }
    }

    private class ContributorData
    {
        public string Username { get; set; } = string.Empty;
        public int Count { get; set; }
    }
}
