@page "/roleswitch"
@using WorkOrderManagementSystem.Data
@using Microsoft.EntityFrameworkCore
@inject WorkOrderContext Db
@inject NavigationManager Nav
@rendermode InteractiveServer

<PageTitle>Role Switcher (Testing Only)</PageTitle>

<div class="container mt-5">
    <div class="card shadow-glass border-0 p-4">
        <h2 class="mb-4"><i class="bi bi-shuffle me-2"></i>Role Switcher (Testing Mode)</h2>
        
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <strong>Testing Tool:</strong> This page allows you to quickly switch roles for testing. Remove in production!
        </div>

        <div class="mb-4">
            <h5>Current User: <span class="text-primary">@currentUsername</span></h5>
            <h5>Current Role: <span class="badge" style="@GetRoleBadgeStyle()">@currentRole</span></h5>
        </div>

        <div class="row g-3">
            <div class="col-md-4">
                <button class="btn btn-outline-secondary w-100 p-3" @onclick='() => SwitchRole(Role.User)'>
                    <i class="bi bi-person-fill fs-3 d-block mb-2"></i>
                    <strong>Switch to User</strong>
                    <small class="d-block text-muted">Basic access only</small>
                </button>
            </div>
            <div class="col-md-4">
                <button class="btn btn-outline-info w-100 p-3" @onclick='() => SwitchRole(Role.Worker)'>
                    <i class="bi bi-wrench fs-3 d-block mb-2"></i>
                    <strong>Switch to Worker</strong>
                    <small class="d-block text-muted">Task management</small>
                </button>
            </div>
            <div class="col-md-4">
                <button class="btn btn-outline-danger w-100 p-3" @onclick='() => SwitchRole(Role.Admin)'>
                    <i class="bi bi-shield-fill-check fs-3 d-block mb-2"></i>
                    <strong>Switch to Admin</strong>
                    <small class="d-block text-muted">Full access</small>
                </button>
            </div>
        </div>

        @if (!string.IsNullOrEmpty(message))
        {
            <div class="alert alert-success mt-4">
                @message
                <br/>
                <small>Refresh the page or navigate to see changes take effect.</small>
            </div>
        }

        <div class="mt-4">
            <button class="btn btn-primary" @onclick='() => Nav.NavigateTo("/", true)'>
                <i class="bi bi-house-door me-2"></i>Go to Dashboard
            </button>
            <button class="btn btn-secondary ms-2" @onclick='() => Nav.NavigateTo("/workorders", true)'>
                <i class="bi bi-list-check me-2"></i>Go to Work Orders
            </button>
        </div>
    </div>

    <div class="card shadow-glass border-0 p-4 mt-4">
        <h4 class="mb-3">Role Comparison</h4>
        <table class="table table-sm">
            <thead>
                <tr>
                    <th>Feature</th>
                    <th class="text-center">User</th>
                    <th class="text-center">Worker</th>
                    <th class="text-center">Admin</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Create Work Orders</td>
                    <td class="text-center"><i class="bi bi-check-circle-fill text-success"></i></td>
                    <td class="text-center"><i class="bi bi-check-circle-fill text-success"></i></td>
                    <td class="text-center"><i class="bi bi-check-circle-fill text-success"></i></td>
                </tr>
                <tr>
                    <td>View All Orders</td>
                    <td class="text-center"><i class="bi bi-x-circle-fill text-danger"></i></td>
                    <td class="text-center"><i class="bi bi-check-circle-fill text-success"></i></td>
                    <td class="text-center"><i class="bi bi-check-circle-fill text-success"></i></td>
                </tr>
                <tr>
                    <td>Edit Status/Priority</td>
                    <td class="text-center"><i class="bi bi-x-circle-fill text-danger"></i></td>
                    <td class="text-center"><i class="bi bi-check-circle-fill text-success"></i></td>
                    <td class="text-center"><i class="bi bi-check-circle-fill text-success"></i></td>
                </tr>
                <tr>
                    <td>Delete Orders</td>
                    <td class="text-center"><i class="bi bi-x-circle-fill text-danger"></i></td>
                    <td class="text-center"><i class="bi bi-x-circle-fill text-danger"></i></td>
                    <td class="text-center"><i class="bi bi-check-circle-fill text-success"></i></td>
                </tr>
                <tr>
                    <td>Analytics Dashboard</td>
                    <td class="text-center"><i class="bi bi-x-circle-fill text-danger"></i></td>
                    <td class="text-center"><i class="bi bi-check-circle-fill text-success"></i></td>
                    <td class="text-center"><i class="bi bi-check-circle-fill text-success"></i></td>
                </tr>
                <tr>
                    <td>Export Reports</td>
                    <td class="text-center"><i class="bi bi-x-circle-fill text-danger"></i></td>
                    <td class="text-center"><i class="bi bi-x-circle-fill text-danger"></i></td>
                    <td class="text-center"><i class="bi bi-check-circle-fill text-success"></i></td>
                </tr>
                <tr>
                    <td>Manage Users</td>
                    <td class="text-center"><i class="bi bi-x-circle-fill text-danger"></i></td>
                    <td class="text-center"><i class="bi bi-x-circle-fill text-danger"></i></td>
                    <td class="text-center"><i class="bi bi-check-circle-fill text-success"></i></td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

@code {
    private string currentUsername = "";
    private Role currentRole = Role.User;
    private string message = "";

    protected override async Task OnInitializedAsync()
    {
        try
        {
            currentUsername = System.Security.Principal.WindowsIdentity.GetCurrent()?.Name ?? Environment.UserName;
        }
        catch
        {
            currentUsername = "Guest";
        }

        var userRole = await Db.UserRoles.FirstOrDefaultAsync(u => u.Username == currentUsername);
        currentRole = userRole?.Role ?? Role.User;
    }

    private async Task SwitchRole(Role newRole)
    {
        var existingRole = await Db.UserRoles.FirstOrDefaultAsync(u => u.Username == currentUsername);

        if (newRole == Role.User)
        {
            // Remove from UserRoles table (becomes default User)
            if (existingRole != null)
            {
                Db.UserRoles.Remove(existingRole);
                await Db.SaveChangesAsync();
            }
            message = $"✅ Switched to User role. You now have basic access only.";
        }
        else
        {
            if (existingRole != null)
            {
                // Update existing role
                existingRole.Role = newRole;
            }
            else
            {
                // Create new role entry
                Db.UserRoles.Add(new UserRole
                {
                    Username = currentUsername,
                    Role = newRole
                });
            }
            await Db.SaveChangesAsync();
            message = $"✅ Switched to {newRole} role. Navigate to see new permissions.";
        }

        currentRole = newRole;
        StateHasChanged();
    }

    private string GetRoleBadgeStyle() => currentRole switch
    {
        Role.Admin => "background: linear-gradient(135deg, #f43f5e 0%, #fb7185 100%); color: white; padding: 0.5rem 1rem;",
        Role.Worker => "background: linear-gradient(135deg, #0ea5e9 0%, #38bdf8 100%); color: white; padding: 0.5rem 1rem;",
        _ => "background: linear-gradient(135deg, #64748b 0%, #94a3b8 100%); color: white; padding: 0.5rem 1rem;"
    };
}
