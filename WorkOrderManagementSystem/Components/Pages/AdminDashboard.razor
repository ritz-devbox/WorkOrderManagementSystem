@page "/admin/dashboard"
@using WorkOrderManagementSystem.Data
@using WorkOrderManagementSystem.Services
@using Microsoft.EntityFrameworkCore
@inject WorkOrderContext Db
@inject SessionService Session
@inject NavigationManager Nav
@layout WorkOrderManagementSystem.Components.Layout.AdminLayout

<PageTitle>Admin Dashboard</PageTitle>

@if (!Session.IsAuthenticated || Session.CurrentRole != Role.Admin)
{
    <div class="container mt-5">
        <div class="alert alert-danger">
            <i class="bi bi-shield-exclamation me-2"></i>
            Administrative access required. Please <a href="/admin/login">login</a>.
        </div>
    </div>
    Nav.NavigateTo("/admin/login");
    return;
}

<div class="container-fluid mt-4 animate-fade-in">
    <!-- Header -->
    <div class="row mb-4 align-items-center">
        <div class="col-md-8">
            <h1 class="display-5 fw-bold mb-2">
                <i class="bi bi-shield-fill-check me-3 text-danger"></i>Admin Dashboard
            </h1>
            <p class="lead text-muted">Welcome, <strong>@Session.CurrentUser?.FullName</strong></p>
        </div>
        <div class="col-md-4 text-md-end">
            <button class="btn btn-outline-primary rounded-pill me-2" @onclick='() => Nav.NavigateTo("/analytics")'>
                <i class="bi bi-graph-up me-2"></i>Analytics
            </button>
            <button class="btn btn-outline-danger rounded-pill" @onclick="Logout">
                <i class="bi bi-box-arrow-right me-2"></i>Logout
            </button>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row g-4 mb-5">
        <div class="col-md-3">
            <div class="card border-0 shadow-glass h-100 animate-float" style="animation-delay: 0s;">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div class="p-3 rounded-circle bg-warning bg-opacity-10">
                            <i class="bi bi-exclamation-triangle-fill fs-3 text-warning"></i>
                        </div>
                        <span class="badge bg-warning bg-opacity-10 text-warning">Pending</span>
                    </div>
                    <h2 class="display-4 fw-bold mb-1">@unassignedCount</h2>
                    <p class="text-muted mb-0">Unassigned Orders</p>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card border-0 shadow-glass h-100 animate-float" style="animation-delay: 0.1s;">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div class="p-3 rounded-circle bg-primary bg-opacity-10">
                            <i class="bi bi-hourglass-split fs-3 text-primary"></i>
                        </div>
                        <span class="badge bg-primary bg-opacity-10 text-primary">Active</span>
                    </div>
                    <h2 class="display-4 fw-bold mb-1">@inProgressCount</h2>
                    <p class="text-muted mb-0">In Progress</p>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card border-0 shadow-glass h-100 animate-float" style="animation-delay: 0.2s;">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div class="p-3 rounded-circle bg-success bg-opacity-10">
                            <i class="bi bi-check-circle-fill fs-3 text-success"></i>
                        </div>
                        <span class="badge bg-success bg-opacity-10 text-success">Done</span>
                    </div>
                    <h2 class="display-4 fw-bold mb-1">@completedCount</h2>
                    <p class="text-muted mb-0">Total Completed</p>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card border-0 shadow-glass h-100 animate-float" style="animation-delay: 0.3s;">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div class="p-3 rounded-circle bg-info bg-opacity-10">
                            <i class="bi bi-people-fill fs-3 text-info"></i>
                        </div>
                        <span class="badge bg-info bg-opacity-10 text-info">Team</span>
                    </div>
                    <h2 class="display-4 fw-bold mb-1">@activeWorkers</h2>
                    <p class="text-muted mb-0">Active Workers</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Unassigned Orders - Assignment Interface -->
    <div class="card border-0 shadow-glass mb-4">
        <div class="card-header bg-transparent border-0 pt-4 px-4">
            <h4 class="mb-0 fw-bold">
                <i class="bi bi-clipboard-x me-2 text-warning"></i>Unassigned Work Orders
            </h4>
        </div>
        <div class="card-body p-0">
            @if (unassignedOrders.Any())
            {
                <div class="list-group list-group-flush">
                    @foreach (var order in unassignedOrders)
                    {
                        <div class="list-group-item p-4 border-top">
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <div class="d-flex gap-2 mb-2">
                                        <span class="badge @GetPriorityBadgeClass(order.Priority)">@order.Priority</span>
                                        <span class="badge bg-light text-dark">@order.Category?.Name</span>
                                        <span class="badge bg-secondary">ID: WO-@order.Id.ToString("D3")</span>
                                    </div>
                                    <h5 class="fw-bold mb-2">@order.Description</h5>
                                    <p class="text-muted small mb-0">
                                        <i class="bi bi-person me-1"></i>@order.Username
                                        <span class="mx-2">•</span>
                                        <i class="bi bi-geo-alt me-1"></i>@order.Location
                                        <span class="mx-2">•</span>
                                        <i class="bi bi-clock me-1"></i>@order.Timestamp.ToLocalTime().ToString("g")
                                    </p>
                                </div>
                                <div class="col-md-6 mt-3 mt-md-0">
                                    <div class="row g-2">
                                        <div class="col-md-7">
                                            <select class="form-select shadow-none" @onchange="(e) => selectedWorkers[order.Id] = e.Value?.ToString() ?? string.Empty">
                                                <option value="">Select worker...</option>
                                                @foreach (var worker in workers)
                                                {
                                                    <option value="@worker.Username">@worker.FullName</option>
                                                }
                                            </select>
                                        </div>
                                        <div class="col-md-5">
                                            <button class="btn btn-primary w-100 shadow-glow" 
                                                    @onclick="() => AssignOrder(order.Id)"
                                                    disabled="@(!selectedWorkers.ContainsKey(order.Id) || string.IsNullOrEmpty(selectedWorkers[order.Id]))">
                                                <i class="bi bi-person-check me-1"></i>Assign
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="text-center py-5">
                    <i class="bi bi-check-circle fs-1 text-success opacity-50"></i>
                    <p class="text-muted mt-3">All work orders have been assigned!</p>
                </div>
            }
        </div>
    </div>

    <!-- All Orders Overview -->
    <div class="card border-0 shadow-glass">
        <div class="card-header bg-transparent border-0 pt-4 px-4">
            <h4 class="mb-0 fw-bold">
                <i class="bi bi-list-check me-2 text-primary"></i>All Work Orders
            </h4>
        </div>
        <div class="card-body p-0">
            @if (allOrders.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th>ID</th>
                                <th>Description</th>
                                <th>Status</th>
                                <th>Priority</th>
                                <th>Assigned To</th>
                                <th>Created</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var order in allOrders.Take(10))
                            {
                                <tr>
                                    <td class="fw-bold">WO-@order.Id.ToString("D3")</td>
                                    <td>@order.Description</td>
                                    <td><span class="badge @GetStatusBadgeClass(order.Status)">@order.Status</span></td>
                                    <td><span class="badge @GetPriorityBadgeClass(order.Priority)">@order.Priority</span></td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(order.AssignedTo))
                                        {
                                            <span class="text-success">
                                                <i class="bi bi-person-check me-1"></i>@order.AssignedTo
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">Unassigned</span>
                                        }
                                    </td>
                                    <td class="text-muted small">@order.Timestamp.ToLocalTime().ToString("g")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private List<WorkOrder> unassignedOrders = new();
    private List<WorkOrder> allOrders = new();
    private List<WorkerAccount> workers = new();
    private Dictionary<int, string> selectedWorkers = new();
    
    private int unassignedCount;
    private int inProgressCount;
    private int completedCount;
    private int activeWorkers;

    protected override async Task OnInitializedAsync()
    {
        if (Session.IsAuthenticated && Session.CurrentRole == Role.Admin)
        {
            await LoadData();
        }
    }

    private async Task LoadData()
    {
        // Load workers
        workers = await Db.WorkerAccounts
            .Where(w => w.Role == Role.Worker && w.IsActive)
            .ToListAsync();

        // Load unassigned orders
        unassignedOrders = await Db.WorkOrders
            .Include(w => w.Category)
            .Where(w => string.IsNullOrEmpty(w.AssignedTo))
            .OrderByDescending(w => w.Priority)
            .ThenBy(w => w.Timestamp)
            .ToListAsync();

        // Load all orders
        allOrders = await Db.WorkOrders
            .Include(w => w.Category)
            .OrderByDescending(w => w.Timestamp)
            .ToListAsync();
        // Calculate stats
        unassignedCount = unassignedOrders.Count;
        inProgressCount = allOrders.Count(w => w.Status == WorkOrderStatus.InProgress);
        
        completedCount = await Db.WorkOrders.CountAsync(w => w.Status == WorkOrderStatus.Completed);
        activeWorkers = workers.Count;
    }

    private async Task AssignOrder(int orderId)
    {
        if (!selectedWorkers.ContainsKey(orderId) || string.IsNullOrEmpty(selectedWorkers[orderId]))
            return;

        var order = await Db.WorkOrders.FindAsync(orderId);
        if (order != null)
        {
            order.AssignedTo = selectedWorkers[orderId];
            order.AssignedDate = DateTime.UtcNow;
            await Db.SaveChangesAsync();
            
            selectedWorkers.Remove(orderId);
            await LoadData();
        }
    }

    private void Logout()
    {
        Session.Logout();
        Nav.NavigateTo("/admin/login");
    }

    private string GetPriorityBadgeClass(WorkOrderPriority p) => p switch
    {
        WorkOrderPriority.Low => "bg-info",
        WorkOrderPriority.Medium => "bg-primary",
        WorkOrderPriority.High => "bg-warning text-dark",
        WorkOrderPriority.Critical => "bg-danger",
        _ => "bg-secondary"
    };

    private string GetStatusBadgeClass(WorkOrderStatus s) => s switch
    {
        WorkOrderStatus.New => "bg-secondary",
        WorkOrderStatus.InProgress => "bg-primary",
        WorkOrderStatus.Completed => "bg-success",
        _ => "bg-light text-dark"
    };
}
