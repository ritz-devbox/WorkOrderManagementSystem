@using WorkOrderManagementSystem.Services
@inject NotificationService NotificationService
@implements IDisposable

<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;">
    @foreach (var notification in notifications)
    {
        <div class="toast show animate-fade-in" role="alert">
            <div class="toast-header @GetHeaderClass(notification.Type) text-white border-0">
                <i class="bi @GetIcon(notification.Type) me-2"></i>
                <strong class="me-auto">@notification.Title</strong>
                <small>just now</small>
                <button type="button" class="btn-close btn-close-white" @onclick="() => RemoveNotification(notification)"></button>
            </div>
            <div class="toast-body">
                @notification.Message
            </div>
        </div>
    }
</div>

@code {
    private List<ToastNotification> notifications = new();
    
    protected override void OnInitialized()
    {
        NotificationService.OnNotification += HandleNotification;
    }
    
    private void HandleNotification(string title, string message, NotificationType type)
    {
        var notification = new ToastNotification
        {
            Id = Guid.NewGuid(),
            Title = title,
            Message = message,
            Type = type,
            Timestamp = DateTime.Now
        };
        
        notifications.Add(notification);
        StateHasChanged();
        
        // Auto-remove after 5 seconds
        Task.Delay(5000).ContinueWith(_ =>
        {
            InvokeAsync(() =>
            {
                RemoveNotification(notification);
                StateHasChanged();
            });
        });
    }
    
    private void RemoveNotification(ToastNotification notification)
    {
        notifications.Remove(notification);
    }
    
    private string GetHeaderClass(NotificationType type) => type switch
    {
        NotificationType.Success => "bg-success",
        NotificationType.Warning => "bg-warning",
        NotificationType.Error => "bg-danger",
        _ => "bg-primary"
    };
    
    private string GetIcon(NotificationType type) => type switch
    {
        NotificationType.Success => "bi-check-circle-fill",
        NotificationType.Warning => "bi-exclamation-triangle-fill",
        NotificationType.Error => "bi-x-circle-fill",
        _ => "bi-info-circle-fill"
    };
    
    public void Dispose()
    {
        NotificationService.OnNotification -= HandleNotification;
    }
    
    private class ToastNotification
    {
        public Guid Id { get; set; }
        public string Title { get; set; } = "";
        public string Message { get; set; } = "";
        public NotificationType Type { get; set; }
        public DateTime Timestamp { get; set; }
    }
}
